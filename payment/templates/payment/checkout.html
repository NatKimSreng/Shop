{% extends 'store/main.html' %}
{% block content %}
{% load static %}
<div class="container mt-5">
    <h1>Checkout</h1>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
    
    {% if items %}
        <h3>Order Summary</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr>
                        <td>
                            <img src="{{ item.product.imageURL }}" alt="{{ item.product.name }}" width="50">
                            {{ item.product.name }}
                        </td>
                        <td>${{ item.product.price|floatformat:2 }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>${{ item.get_total|floatformat:2 }}</td>
                    </tr>
                {% endfor %}
                <tr>
                    <td colspan="3"><strong>Subtotal:</strong> {{ order.get_cart_items }} item(s)</td>
                    <td><strong>${{ order.get_cart_total|floatformat:2 }}</strong></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>Delivery:</strong></td>
                    <td><strong>${{ order.delivery_cost|floatformat:2 }}</strong></td>
                </tr>
                <tr>
                    <td colspan="3"><strong>Grand Total:</strong></td>
                    <td><strong>${{ order.grand_total|floatformat:2 }}</strong></td>
                </tr>
            </tbody>
        </table>
        
         <h4>Shipping Information</h4>
                    <form method="post" class="needs-validation" novalidate>
                        {% csrf_token %}
                        <div class="row">
                            {% for field in shipping_form %}
                                <div class="col-md-6 mb-3">
                                    {{ field.label_tag }}
                                    {{ field }}
                                    {% if field.help_text %}
                                        <small class="form-text text-muted">{{ field.help_text }}</small>
                                    {% endif %}
                                    {% if field.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ field.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        <h4 class="mt-4">Delivery Options</h4>
                        <select name="delivery_option" class="form-select mb-3" id="deliveryOption">
                            {% for option in delivery_options %}
                                <option value="{{ option.id }}" {% if option.id|stringformat:"s" == selected_delivery_id|stringformat:"s" %}selected{% endif %}>
                                    {{ option.name }} - ${{ option.price|floatformat:2 }} (Est. {{ option.estimated_days }} days)
                                </option>
                            {% endfor %}
                        </select>
                        <h4 class="mt-4">Payment Method</h4>
                        <div class="mb-3">
                            {{ payment_form.payment_method.label_tag }}
                            {{ payment_form.payment_method }}
                            {% if payment_form.payment_method.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ payment_form.payment_method.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div id="qrCodeContainer" class="qr-code-container">
                          <h5 class="mb-2">Scan to Pay</h5>
                          <img id="qrCodeImage" src="{% static 'images/Qrcode.jpg' %}" alt="Bank Transfer QR Code" class="qr-code-img">
                          <p class="qr-placeholder">After paid we will sent you an invoice</p>
                          

                      </div>
                          <button type="submit" class="btn btn-primary mt-3 w-100">Place Order</button>
                    </form>

    {% else %}
        <p>Your cart is empty.</p>
        <a href="{% url 'home' %}" class="btn btn-secondary">Continue Shopping</a>
    {% endif %}
</div>
 <style>
        .qr-code-container {
            display: none;
            text-align: center;
            margin-top: 1.5rem;
            padding: 15px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .qr-code-img {
            max-width: 200px;
            border: 2px solid #007bff;
            border-radius: 6px;
        }
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        .cart-item img {
            max-width: 80px;
            border-radius: 4px;
        }
        .qr-placeholder {
            color: #6c757d;
            font-style: italic;
        }
    </style>
 <script>
        function toggleQRCode() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const qrCodeContainer = document.getElementById('qrCodeContainer');
            qrCodeContainer.style.display = paymentMethod === 'bank_transfer' ? 'block' : 'none';
        }
        document.addEventListener('DOMContentLoaded', toggleQRCode);
        document.getElementById('paymentMethod').addEventListener('change', toggleQRCode);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}