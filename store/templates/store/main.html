{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Django Ecommerce</title>
    <!-- Favicon-->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}" />
    <link
      rel="icon"
      type="images/png"
      href="{% static 'favicon/apple-touch-icon.png' %}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="{% url 'home' %}">Ecom</a>
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="{% url 'home' %}">Home</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="{% url 'store' %}"
              >Store <span class="sr-only">(current)</span></a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'category' 'Iphone' %}">Iphone</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'category' 'Pixel' %}">Pixel</a>
          </li>
        </ul>

        <div class="form-inline my-2 my-lg-0">
          {% if user.is_authenticated %}
          <a href="#" class="btn btn-primary"
            ><img
              id="cart-icon"
              src="{% static 'images/user.png' %}"
            />{{user}}</a
          >
          <a href="{% url 'logout' %}" class="btn btn-danger">Logout</a>
          {% else %}
          <a href="{% url 'login' %}" class="btn btn-primary">Login</a>
          <a href="{% url 'register' %}" class="btn btn-primary">register</a>
          {% endif %}
          <a href="{% url 'cart_summary' %}">
            <img id="cart-icon" src="{% static 'images/cart.png' %}" />
          </a>

          <span
            class="badge bg-dark text-white ms-1 rounded-pill"
            id="cart_quantity"
            >{{ cart|length }}
          </span>
        </div>
      </div>
    </nav>
    {% if messages %} {% for message in messages %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
      {{ message }}
      <button
        type="button"
        class="btn-close"
        data-bs-dismiss="alert"
        aria-label="Close"
      ></button>
    </div>
    {% endfor %} {% endif %} {% block content %} {% endblock %}


    {% comment %} footer {% endcomment %}
    <footer class="bg-dark text-light py-5 mt-5" id="footer">
      <div class="container">
          <div class="row">
              <!-- Company Info Column -->
              <div class="col-md-4 mb-4">
                  <h5 class="mb-3">OtDeng</h5>
                  <p class="text-white">Premium quality products delivered to your doorstep. Shop with confidence with our secure payment and fast shipping.</p>
                  <div class="d-flex mt-3">
                      <a href="https://www.facebook.com/kim.sreng.7921975" class="text-light me-3"><i class="bi bi-facebook"></i></a>
                      <a href="#" class="text-light me-3"><i class="bi bi-instagram"></i></a>
                      <a href="#" class="text-light me-3"><i class="bi bi-twitter-x"></i></a>
                  </div>
              </div>
              
              <!-- Quick Links Column -->
              <div class="col-md-3 mb-4">
                  <h5 class="mb-3">Quick Links</h5>
                  <ul class="list-unstyled">
                      <li class="mb-2"><a href="https://www.youtube.com/watch?v=F7kMGUDDhTQ" class="text-decoration-none text-white">Home</a></li>
                      <li class="mb-2"><a href="https://www.youtube.com/watch?v=F7kMGUDDhTQ" class="text-decoration-none text-white">Shop</a></li>
                      <li class="mb-2"><a href="https://www.youtube.com/watch?v=F7kMGUDDhTQ" class="text-decoration-none text-white">About Us</a></li>
                      <li class="mb-2"><a href="https://www.youtube.com/watch?v=F7kMGUDDhTQ" class="text-decoration-none text-white">Contact</a></li>
                  </ul>
              </div>
              
              <!-- Customer Service Column -->
              <div class="col-md-2 mb-4">
                  <h5 class="mb-3">Customer Service</h5>
                  <ul class="list-unstyled">
                      <li class="mb-2"><a href="#" class="text-decoration-none text-white">FAQ</a></li>
                      <li class="mb-2"><a href="#" class="text-decoration-none text-white">Shipping Policy</a></li>
                      <li class="mb-2"><a href="#" class="text-decoration-none text-white">Returns</a></li>
                      <li class="mb-2"><a href="#" class="text-decoration-none text-white">Terms & Conditions</a></li>
                      <li class="mb-2"><a href="#" class="text-decoration-none text-white">Privacy Policy</a></li>
                  </ul>
              </div>
              
              <!-- Newsletter Column -->
              <div class="col-md-3 mb-4">
                  <h5 class="mb-3">Newsletter</h5>
                  <p class="text-white">Subscribe to receive updates, access to exclusive deals, and more.</p>
                 
              </div>
          </div>
          
          <!-- Bottom footer with copyright -->
          <div class="row mt-4 pt-4 border-top border-secondary">
              <div class="col-md-6 text-center text-md-start">
                  <p class="text-white">&copy; {% now "Y" %} OtDeng. All rights reserved.</p>
              </div>
              <div class="col-md-6 text-center text-md-end">
                  {% comment %} <img src="{% static 'images/logo.png' %}" alt="Payment Methods" class="img-fluid" style="max-height: 30px;"> {% endcomment %}
              </div>
          </div>
      </div>
    </footer>
  <!-- Back to top button -->
    <div class="position-fixed bottom-0 end-0 p-3">
        <button type="button" class="btn btn-primary rounded-circle shadow" id="backToTopBtn" 
                onclick="window.scrollTo({top: 0, behavior: 'smooth'})" 
                style="width: 45px; height: 45px; display: none;">
            <i class="bi bi-arrow-up"></i>
        </button>
    </div>

    <!-- Script for back to top button -->
    <script>
        // Back to top button logic
        window.onscroll = function() {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                document.getElementById("backToTopBtn").style.display = "block";
            } else {
                document.getElementById("backToTopBtn").style.display = "none";
            }
        };
    </script>
     </div>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
      integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>

    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      var $j = jQuery.noConflict();
    </script>
    <script>
      const cartUpdateUrl = "{% url 'cart_update' %}";
      const cartDeleteUrl = "{% url 'cart_delete' %}";
      const csrfToken = "{{ csrf_token }}";
      var $j = jQuery.noConflict();
      $j(document).ready(function () {
        // Add to Cart (product listing and detail pages)
        $j(document).on("click", ".add-cart", function (e) {
          e.preventDefault();
          var $button = $j(this);
          var product_id = $button.val();
          var product_qty = $j("#qty-cart").length ? $j("#qty-cart").val() : 1;

          if (
            !product_id ||
            !product_qty ||
            isNaN(product_qty) ||
            product_qty < 1
          ) {
            console.error("Invalid product ID or quantity", {
              product_id,
              product_qty,
            });
            alert("Please select a valid product and quantity.");
            return;
          }

          $button.prop("disabled", true).text("Adding...");
          $j.ajax({
            type: "POST",
            url: '{% url "cart_add" %}',
            data: {
              product_id: product_id,
              product_qty: product_qty,
              csrfmiddlewaretoken: "{{ csrf_token }}",
              action: "post",
            },
            success: function (json) {
              $button.prop("disabled", false).text("Add to Cart");
              if (document.getElementById("cart_quantity")) {
                document.getElementById("cart_quantity").textContent = json.qty;
              }
              alert("Product added to cart!");
            },
            error: function (xhr, errmsg, err) {
              $button.prop("disabled", false).text("Add to Cart");
              console.error(
                "Error:",
                xhr.responseJSON ? xhr.responseJSON.error : "Unknown error"
              );
              alert(
                "Failed to add to cart: " +
                  (xhr.responseJSON ? xhr.responseJSON.error : "Unknown error")
              );
            },
          });
        });
        $j(document).on("click", ".delete-cart", function (e) {
          e.preventDefault();
          const $button = $j(this);
          const product_id = $button.data("product-id");
          const action = $button.data("action");

          if (!product_id || !action) {
            console.error("Missing product_id or action");
            alert("Invalid product or action.");
            return;
          }

          $button.addClass("loading").prop("disabled", true);

          $j.ajax({
            type: "POST",
            url: "{% url 'cart_delete' %}",
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            data: {
              product_id: product_id,
              action: action,
            },
            dataType: "json",
            success: function (json) {
              $button.removeClass("loading").prop("disabled", false);
              if (!json.success) {
                alert(json.error || "An error occurred.");
                return;
              }
              location.reload();
            },

            error: function (xhr) {
              $button.removeClass("loading").prop("disabled", false);
              const errorMsg =
                xhr.responseJSON?.error ||
                "An error occurred. Please try again.";
              console.error("Error:", errorMsg);
              alert(errorMsg);
            },
          });
        });
        // Update Cart (cart summary page)
        $j(document).on("click", ".update-cart", function (e) {
          e.preventDefault();
          var $button = $j(this);
          var product_id = $button.data("product-id");
          var action = $button.data("action");

          $button.prop("disabled", true);
          $j.ajax({
            type: "POST",
            url: '{% url "cart_update" %}',
            data: {
              product_id: product_id,
              action_type: action,
              csrfmiddlewaretoken: "{{ csrf_token }}",
              action: "post",
            },
            success: function (json) {
              $button.prop("disabled", false);
              if (document.getElementById("cart_quantity")) {
                document.getElementById("cart_quantity").textContent = json.qty;
              }
              // Update item quantity and total in the DOM
              $button
                .closest(".cart-row")
                .find(".quantity")
                .text(json.item_quantity);
              $button
                .closest(".cart-row")
                .find("div:last p")
                .text("$" + json.cart_total.toFixed(2));
              // Update cart total in the table
              $j("table .table h5 strong:last").text(
                "$" + json.cart_total.toFixed(2)
              );
              // Remove row if quantity is 0
              if (json.item_quantity <= 0) {
                $button.closest(".cart-row").remove();
              }
              location.reload();
            },
            error: function (xhr, errmsg, err) {
              $button.prop("disabled", false);
              console.error(
                "Error:",
                xhr.responseJSON ? xhr.responseJSON.error : "Unknown error"
              );
              alert(
                "Failed to update cart: " +
                  (xhr.responseJSON ? xhr.responseJSON.error : "Unknown error")
              );
            },
          });
        });
      });
    </script>
    <!-- Core theme JS-->
  </body>
</html>
