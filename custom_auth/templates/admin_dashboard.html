{% extends 'sidebar.html' %}
{% load static %}

{% block content %}
<!-- Bootstrap 5 CDN (include only if not in sidebar.html) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Admin Dashboard</h2>
    <button id="darkModeToggle" class="btn btn-outline-dark">ðŸŒ™ Dark Mode</button>
  </div>
  <div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
    <div class="col">
      <div class="card text-white bg-primary h-100">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-people me-2"></i>Users</h5>
          <h2 class="card-text">{{ total_users }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card text-white bg-success h-100">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-box-seam me-2"></i>Products</h5>
          <h2 class="card-text">{{ total_products }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card text-white bg-warning h-100">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-receipt me-2"></i>Orders</h5>
          <h2 class="card-text">{{ total_orders }}</h2>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card text-white bg-danger h-100">
        <div class="card-body">
          <h5 class="card-title"><i class="bi bi-currency-dollar me-2"></i>Sales</h5>
          <h2 class="card-text">${{ total_sales|floatformat:2 }}</h2>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-4 mb-4">
    <div class="col-md-8">
      <div class="card h-100">
        <div class="card-header bg-white fw-bold">Sales Over Time</div>
        <div class="card-body">
          <canvas id="salesChart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header bg-white fw-bold">Order Status Distribution</div>
        <div class="card-body">
          <canvas id="statusChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-white fw-bold">Top Products</div>
        <div class="card-body">
          <ul class="list-group">
            {% for item in top_products %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>{{ item.product.name }}</span>
              <span class="badge bg-primary">${{ item.amount_paid|floatformat:2 }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No top products.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-white fw-bold">Recent Activity</div>
        <div class="card-body">
          <h6>Recent Orders</h6>
          <ul class="list-group mb-3">
            {% for order in recent_orders %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span>Order #{{ order.id }} - {{ order.user.username }}</span>
              <span class="badge bg-info">{{ order.status|default:'Pending' }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No recent orders.</li>
            {% endfor %}
          </ul>
          <h6>Recent Users</h6>
          <ul class="list-group">
            {% for user in recent_users %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              {{ user.username }}
              <span class="badge bg-success">Joined {{ user.date_joined|date:'M d, Y' }}</span>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No recent users.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="row g-4 mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-white fw-bold">Sales by Category</div>
        <div class="card-body">
          <canvas id="categoryChart" height="180"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-white fw-bold">Order Status Overview</div>
        <div class="card-body">
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3">
            <div class="col">
              <p class="fw-semibold">Pending</p>
              <p class="fs-5 text-primary">{{ status_counts.PENDING }}</p>
            </div>
            <div class="col">
              <p class="fw-semibold">Shipped</p>
              <p class="fs-5 text-primary">{{ status_counts.SHIPPED }}</p>
            </div>
            <div class="col">
              <p class="fw-semibold">Delivered</p>
              <p class="fs-5 text-primary">{{ status_counts.DELIVERED }}</p>
            </div>
            <div class="col">
              <p class="fw-semibold">Cancelled</p>
              <p class="fs-5 text-primary">{{ status_counts.CANCELLED }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Sales Over Time Chart
  const salesCtx = document.getElementById('salesChart').getContext('2d');
  new Chart(salesCtx, {
    type: 'bar',
    data: {
      labels: ['Today', 'This Month', 'This Year'],
      datasets: [{
        label: 'Sales Amount ($)',
        data: [{{ total_today|floatformat:2 }}, {{ total_month|floatformat:2 }}, {{ total_year|floatformat:2 }}],
        backgroundColor: ['#0d6efd', '#198754', '#ffc107'],
        borderColor: ['#0d6efd', '#198754', '#ffc107'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Amount ($)', font: { size: 14 } }
        },
        x: {
          title: { display: true, text: 'Time Period', font: { size: 14 } }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: { enabled: true }
      }
    }
  });

  // Order Status Distribution Pie Chart
  const statusCtx = document.getElementById('statusChart').getContext('2d');
  new Chart(statusCtx, {
    type: 'pie',
    data: {
      labels: ['Pending', 'Shipped', 'Delivered', 'Cancelled'],
      datasets: [{
        data: [{{ status_counts.PENDING }}, {{ status_counts.SHIPPED }}, {{ status_counts.DELIVERED }}, {{ status_counts.CANCELLED }}],
        backgroundColor: ['#dc3545', '#0d6efd', '#198754', '#6c757d'],
        borderColor: ['#dc3545', '#0d6efd', '#198754', '#6c757d'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 12 } } },
        tooltip: { enabled: true }
      }
    }
  });

  // Sales by Category Pie Chart
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(categoryCtx, {
    type: 'pie',
    data: {
      labels: [{% for cat in sales_by_category %}'{{ cat.category }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        data: [{% for cat in sales_by_category %}{{ cat.total|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6c757d', '#6610f2', '#fd7e14'],
        borderColor: ['#fff'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'bottom', labels: { font: { size: 12 } } },
        tooltip: { enabled: true }
      }
    }
  });

  // Dark Mode Toggle
  const darkModeToggle = document.getElementById('darkModeToggle');
  darkModeToggle.addEventListener('click', function() {
    document.body.classList.toggle('bg-dark');
    document.body.classList.toggle('text-white');
    document.querySelectorAll('.card').forEach(card => {
      card.classList.toggle('bg-dark');
      card.classList.toggle('text-white');
      card.classList.toggle('border-light');
    });
    document.querySelectorAll('.table').forEach(table => {
      table.classList.toggle('table-dark');
    });
  });
</script>
{% endblock %}