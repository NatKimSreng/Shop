{% extends 'sidebar.html' %}
{% load static %}

{% block content %}
<!-- Bootstrap 5 CDN (include only if not in sidebar.html) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<div class="container my-4">
  <h1 class="display-5 fw-bold mb-4 d-flex align-items-center">
    <svg class="me-2" width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2M9 19"></path></svg>
    Admin Dashboard
  </h1>

  {% if messages %}
  <div class="mb-4">
    {% for message in messages %}
    <div class="alert alert-info border-start border-4 border-info" role="alert">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Filter Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="card-title h5 fw-bold mb-3 d-flex align-items-center">
        <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
        Filters
      </h2>
      <form method="get" action="{% url 'admin_dashboard' %}" class="row g-3">
        <div class="col-md-4">
          <label class="form-label fw-medium">Brand</label>
          <select name="brand" class="form-select">
            <option value="">All Brands</option>
            {% for brand in target_brands %}
            <option value="{{ brand }}" {% if selected_brand == brand %}selected{% endif %}>{{ brand }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-medium">Status</label>
          <select name="status" class="form-select">
            <option value="">All Statuses</option>
            <option value="PENDING" {% if selected_status == 'PENDING' %}selected{% endif %}>Pending</option>
            <option value="SHIPPED" {% if selected_status == 'SHIPPED' %}selected{% endif %}>Shipped</option>
            <option value="DELIVERED" {% if selected_status == 'DELIVERED' %}selected{% endif %}>Delivered</option>
            <option value="CANCELLED" {% if selected_status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-medium">Date Range</label>
          <select name="date" class="form-select">
            <option value="">Any Date</option>
            <option value="today" {% if selected_date == 'today' %}selected{% endif %}>Today</option>
            <option value="past_7_days" {% if selected_date == 'past_7_days' %}selected{% endif %}>Past 7 Days</option>
            <option value="this_month" {% if selected_date == 'this_month' %}selected{% endif %}>This Month</option>
            <option value="this_year" {% if selected_date == 'this_year' %}selected{% endif %}>This Year</option>
          </select>
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-primary d-flex align-items-center">
            <svg class="me-2" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            Apply Filters
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Navigation Links -->
  <div class="mb-4 d-flex gap-3">
    <a href="{% url 'admin_order_list' %}" class="btn btn-primary d-flex align-items-center">
      <svg class="me-2" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
      View All Orders
    </a>
    <a href="{% url 'admin_product_list' %}" class="btn btn-primary d-flex align-items-center">
      <svg class="me-2" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
      Manage Products
    </a>
  </div>

  <!-- Total Amounts -->
  <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
    <div class="col">
      <div class="card shadow-sm h-100 dashboard-card">
        <div class="card-body">
          <h2 class="card-title h6 fw-bold mb-2 d-flex align-items-center">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Total Sales Today
          </h2>
          <p class="card-text fs-4 fw-bold text-primary">${{ total_today|floatformat:2 }}</p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card shadow-sm h-100 dashboard-card">
        <div class="card-body">
          <h2 class="card-title h6 fw-bold mb-2 d-flex align-items-center">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 20" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Total Sales This Month
          </h2>
          <p class="card-text fs-4 fw-bold text-primary">${{ total_month|floatformat:2 }}</p>
        </div>
      </div>
    </div>
    <div class="col">
      <div class="card shadow-sm h-100 dashboard-card">
        <div class="card-body">
          <h2 class="card-title h6 fw-bold mb-2 d-flex align-items-center">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2M9 19"></path></svg>
            Total Sales This Year
          </h2>
          <p class="card-text fs-4 fw-bold text-primary">${{ total_year|floatformat:2 }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Status Counts -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="card-title h5 fw-bold mb-3 d-flex align-items-center">
        <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        Order Status Overview
      </h2>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-4 g-3">
        <div class="col">
          <p class="fw-semibold">Pending</p>
          <p class="fs-5 text-primary">{{ status_counts.PENDING }}</p>
        </div>
        <div class="col">
          <p class="fw-semibold">Shipped</p>
          <p class="fs-5 text-primary">{{ status_counts.SHIPPED }}</p>
        </div>
        <div class="col">
          <p class="fw-semibold">Delivered</p>
          <p class="fs-5 text-primary">{{ status_counts.DELIVERED }}</p>
        </div>
        <div class="col">
          <p class="fw-semibold">Cancelled</p>
          <p class="fs-5 text-primary">{{ status_counts.CANCELLED }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
    <!-- Bar Chart for Sales Over Time -->
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="card-title h5 fw-bold mb-3 d-flex align-items-center">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            Sales Over Time
          </h2>
          <div class="chart-container">
            <canvas id="salesChart"></canvas>
          </div>
        </div>
      </div>
    </div>
    <!-- Pie Chart for Status Distribution -->
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="card-title h5 fw-bold mb-3 d-flex align-items-center">
            <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V15h5.488"></path></svg>
            Order Status Distribution
          </h2>
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Sales Table -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="card-title h5 fw-bold mb-3 d-flex align-items-center">
        <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
        Product Prices and Sales
      </h2>
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Brand/Category</th>
              <th>Product Name</th>
              <th>Price</th>
              <th>Sale Price</th>
              <th>In Stock</th>
              <th>Amount Paid</th>
            </tr>
          </thead>
          <tbody>
            {% for item in product_sales %}
            <tr>
              <td>{{ item.category }}</td>
              <td>{{ item.product.name }}</td>
              <td>${{ item.price|floatformat:2 }}</td>
              <td>${{ item.sale_price|floatformat:2 }}</td>
              <td>
                {% if item.is_sale %}
                <span class="text-success">In Stock</span>
                {% else %}
                <span class="text-danger">Out of Stock</span>
                {% endif %}
              </td>
              <td>${{ item.amount_paid|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center">No products found for selected brands.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Sales by Brand Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="card-title h5 fw-bold mb-3 d-flex align-items-center">
        <svg class="me-2" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        Total Sales by Brand
      </h2>
      <div class="table-responsive">
        <table class="table table-bordered table-hover">
          <thead class="table-light">
            <tr>
              <th>Brand</th>
              <th>Total Sales</th>
            </tr>
          </thead>
          <tbody>
            {% for brand, total in sales_by_brand.items %}
            <tr>
              <td>{{ brand }}</td>
              <td>${{ total|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="2" class="text-center">No sales data available.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Custom CSS for Chart Size and Hover Effects -->
  <style>
    .dashboard-card {
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 400px;
      height: 250px;
      margin: 0 auto;
    }
    canvas {
      max-width: 100%;
      max-height: 100%;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // Bar Chart for Sales Over Time
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    new Chart(salesCtx, {
      type: 'bar',
      data: {
        labels: ['Today', 'This Month', 'This Year'],
        datasets: [{
          label: 'Sales Amount ($)',
          data: [{{ total_today|floatformat:2 }}, {{ total_month|floatformat:2 }}, {{ total_year|floatformat:2 }}],
          backgroundColor: ['#0d6efd', '#198754', '#ffc107'],
          borderColor: ['#0d6efd', '#198754', '#ffc107'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            title: { display: true, text: 'Amount ($)', font: { size: 14 } }
          },
          x: {
            title: { display: true, text: 'Time Period', font: { size: 14 } }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        }
      }
    });

    // Pie Chart for Status Distribution
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
      type: 'pie',
      data: {
        labels: ['Pending', 'Shipped', 'Delivered', 'Cancelled'],
        datasets: [{
          data: [{{ status_counts.PENDING }}, {{ status_counts.SHIPPED }}, {{ status_counts.DELIVERED }}, {{ status_counts.CANCELLED }}],
          backgroundColor: ['#dc3545', '#0d6efd', '#198754', '#6c757d'],
          borderColor: ['#dc3545', '#0d6efd', '#198754', '#6c757d'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: { position: 'bottom', labels: { font: { size: 12 } } },
          tooltip: { enabled: true }
        }
      }
    });
  </script>
</div>
{% endblock content %}