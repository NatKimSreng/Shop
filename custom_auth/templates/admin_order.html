{% extends 'sidebar.html' %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-4">Order Management</h1>
  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  
  <!-- Filters -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-md-3">
          <label for="brand_filter" class="form-label">Brand</label>
          <select name="brand" id="brand_filter" class="form-select">
            <option value="">All Brands</option>
            {% for brand in target_brands %}
              <option value="{{ brand }}" {% if brand == selected_brand %}selected{% endif %}>{{ brand }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="status_filter" class="form-label">Status</label>
          <select name="status" id="status_filter" class="form-select">
            <option value="">All</option>
            <option value="PENDING" {% if selected_status == 'PENDING' %}selected{% endif %}>Pending</option>
            <option value="SHIPPED" {% if selected_status == 'SHIPPED' %}selected{% endif %}>Shipped</option>
            <option value="DELIVERED" {% if selected_status == 'DELIVERED' %}selected{% endif %}>Delivered</option>
            <option value="CANCELLED" {% if selected_status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="payment_filter" class="form-label">Payment Method</label>
          <select name="payment" id="payment_filter" class="form-select">
            <option value="">All</option>
            <option value="cod" {% if selected_payment == 'cod' %}selected{% endif %}>Pay on Delivery</option>
            <option value="bank_transfer" {% if selected_payment == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="date_filter" class="form-label">Date Ordered</label>
          <select name="date" id="date_filter" class="form-select">
            <option value="">Any Date</option>
            <option value="today" {% if selected_date == 'today' %}selected{% endif %}>Today</option>
            <option value="past_7_days" {% if selected_date == 'past_7_days' %}selected{% endif %}>Past 7 Days</option>
            <option value="this_month" {% if selected_date == 'this_month' %}selected{% endif %}>This Month</option>
            <option value="this_year" {% if selected_date == 'this_year' %}selected{% endif %}>This Year</option>
          </select>
        </div>
        <div class="col-md-12 d-flex justify-content-end">
          <button type="submit" class="btn btn-primary">Apply Filters</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Orders Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Orders</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Customer</th>
              <th>Total Amount</th>
              <th>Payment Method</th>
              <th>Status</th>
              <th>Date Ordered</th>
              <th>Shipping Address</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for order in orders %}
            <tr>
              <td>{{ order.id }}</td>
              <td>
                {% if order.user %}
                  {{ order.user.username }}
                {% elif order.shipping_address %}
                  {{ order.shipping_address.shipping_full_name }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>${{ order.amount_paid|floatformat:2 }}</td>
              <td>
                {% if order.payment_method == 'cod' %}
                  Pay on Delivery
                {% elif order.payment_method == 'bank_transfer' %}
                  Bank Transfer
                {% else %}
                  {{ order.payment_method }}
                {% endif %}
              </td>
              <td>
                <form method="POST" action="{% url 'admin_order_update_status' order.id %}" class="d-inline">
                  {% csrf_token %}
                  <select name="status" class="form-select form-select-sm d-inline-block" style="width: 120px;">
                    <option value="PENDING" {% if order.status == 'PENDING' %}selected{% endif %}>Pending</option>
                    <option value="SHIPPED" {% if order.status == 'SHIPPED' %}selected{% endif %}>Shipped</option>
                    <option value="DELIVERED" {% if order.status == 'DELIVERED' %}selected{% endif %}>Delivered</option>
                    <option value="CANCELLED" {% if order.status == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                  </select>
                  <button type="submit" class="btn btn-sm btn-primary ms-1">Save</button>
                </form>
              </td>
              <td>{{ order.date_ordered|date:"Y-m-d H:i" }}</td>
              <td>
                {% if order.shipping_address %}
                  {{ order.shipping_address.get_full_address|truncatechars:50 }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>
                <a href="{% url 'admin_order_detail' order.id %}" class="btn btn-sm btn-primary">View</a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center">No orders found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .card { border: none; border-radius: 8px; }
  .table th, .table td { vertical-align: middle; }
  .alert { border-radius: 4px; }
  .btn-sm { margin-right: 5px; }
  .form-select-sm { display: inline-block; }
</style>
{% endblock content %}